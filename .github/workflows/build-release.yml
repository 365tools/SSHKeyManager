name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: sshm.exe
            asset_name: sshm-windows-amd64.exe
          - os: ubuntu-latest
            artifact_name: sshm
            asset_name: sshm-linux-amd64
          - os: macos-latest
            artifact_name: sshm
            asset_name: sshm-macos-amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build with PyInstaller (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          pyinstaller --onefile --name sshm --icon=NONE --console ssh_manager.py

      - name: Build with PyInstaller (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          pyinstaller --onefile --name sshm --console ssh_manager.py

      - name: Test executable (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          .\dist\sshm.exe --help

      - name: Test executable (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          chmod +x ./dist/sshm
          ./dist/sshm --help

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: dist/${{ matrix.artifact_name }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## SSH Key Manager ${{ github.ref_name }}
            
            ### ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒï¼
            
            #### ğŸ“¦ ä¸‹è½½è¯´æ˜
            
            **Windows ç”¨æˆ·**
            - ä¸‹è½½ `sshm-windows-amd64.exe`
            - é‡å‘½åä¸º `sshm.exe`ï¼ˆå¯é€‰ï¼‰
            - åŒå‡»è¿è¡Œæˆ–åœ¨ CMD/PowerShell ä¸­ä½¿ç”¨
            
            **Linux ç”¨æˆ·**
            ```bash
            # ä¸‹è½½
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/sshm-linux-amd64
            
            # èµ‹äºˆæ‰§è¡Œæƒé™
            chmod +x sshm-linux-amd64
            
            # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„ï¼ˆå¯é€‰ï¼‰
            sudo mv sshm-linux-amd64 /usr/local/bin/sshm
            
            # ä½¿ç”¨
            sshm --help
            ```
            
            **macOS ç”¨æˆ·**
            ```bash
            # ä¸‹è½½
            curl -LO https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/sshm-macos-amd64
            
            # èµ‹äºˆæ‰§è¡Œæƒé™
            chmod +x sshm-macos-amd64
            
            # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„ï¼ˆå¯é€‰ï¼‰
            sudo mv sshm-macos-amd64 /usr/local/bin/sshm
            
            # ä½¿ç”¨
            sshm --help
            ```
            
            #### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - å¤šè´¦å· SSH å¯†é’¥ç®¡ç†
            - è‡ªåŠ¨ç»´æŠ¤ SSH config
            - ä¸€é”®åˆ‡æ¢å¯†é’¥
            - è‡ªåŠ¨å¤‡ä»½ä¿æŠ¤
            - è·¨å¹³å°æ”¯æŒ
            
            #### ğŸ“ ä½¿ç”¨æ–‡æ¡£
            æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ï¼š[README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—** è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          draft: false
          prerelease: false
          files: |
            artifacts/sshm-windows-amd64.exe/sshm.exe
            artifacts/sshm-linux-amd64/sshm
            artifacts/sshm-macos-amd64/sshm
